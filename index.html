<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
        crossorigin="anonymous">
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let doubles = false;
        let tournamentId;
        let players;
        let phase;
        let lastRankings;

        $(function () {
            var socket = io();
            socket.on('update', function (data) {
                let overlayContent = data.gameInfo;
                setContent(overlayContent);
                let commentary = data.commInfo;
                setContent(commentary);
                if (data.doubles.enabled) {
                    $(".doubles").show();
                    let dubsEl = data.doubles.content;
                    setContent(dubsEl);
                } else {
                    $(".doubles").hide();
                }
            });
            $('form').submit(function (e) {
                e.preventDefault(); // prevents page reloading
                let player1 = $("#player1").val();
                let player2 = $("#player2").val();
                let player3 = $("#player3").val();
                let player4 = $("#player4").val();
                let score1 = $("#score1").val();
                let score2 = $("#score2").val();
                let link = $("#link").val();
                let bracket = $("#bracket").val();
                let date = $("#date").val();
                let location = $("#location").val();
                let comm1 = $("#commName1").val();
                let commTwit1 = $("#commTwitter1").val();
                let comm2 = $("#commName2").val();
                let commTwit2 = $("#commTwitter2").val();
                socket.emit('update', {
                    gameInfo: {
                        player1: player1,
                        player2: player2,
                        score1: score1,
                        score2: score2,
                        bracket: bracket,
                        link: link,
                        date: date,
                        location: location
                    },
                    commInfo: {
                        commName1: comm1,
                        commTwitter1: commTwit1,
                        commName2: comm2,
                        commTwitter2: commTwit2
                    }, doubles: {
                        enabled: doubles,
                        content: {
                            player3: player3,
                            player4: player4
                        }
                    }, rankings: {
                        lastRankings: lastRankings
                    }
                });
                return false;
            });
        });

        function setContent(obj) {
            let keys = Object.keys(obj);
            keys.forEach((key) => {
                let value = obj[key];
                let currentVal = $(`#${key}`).val();
                if (currentVal !== value) {
                    $(`#${key}`).val(value);
                }
            });
        }

        function doSwapNames(type) {
            if (type === "info") {
                swap("player1", "player2");
                swap("player3", "player4");
                swap("score1", "score2");
            } else {
                swap("commName1", "commName2");
                swap("commTwitter1", "commTwitter1");
            }
        }

        function swap(id1, id2) {
            let value1 = $(`#${id1}`).val();
            let value2 = $(`#${id2}`).val();
            $(`#${id1}`).val(value2);
            $(`#${id2}`).val(value1);
        }

        function getTournamentInfo() {
            $("#results").addClass("hide");
            $("#players").empty();
            $("#event-options").empty();
            $("#select").attr("disabled", true);
            let tournamentSlug = $('#tournamentName').val();
            $("#message").text("");
            fetch(`http://localhost:3000/tournament?name=${tournamentSlug}`).then((response) => {
                return response.json();
            }).then((data) => {
                if (data.status == "success") {
                    let eventSelect = $("#event-options");
                    eventSelect.empty();
                    let tourneyName = data.name;
                    tournamentId = data.id;
                    let events = data.events;
                    events.forEach((event) => {
                        eventSelect.append($(`<option value='${event.id}'>${event.name}</option>`));
                    });
                } else {
                    $("#message").text("No tournament with that identifier found! Please double check that the url is correct!");
                }
                $("#results").removeClass("hide");
            });
        }

        function eventSet() {
            $("#select").attr("disabled", true);
            let eventId = $("#event-options").val();
            let url = `http://localhost:3000/queue?id=${eventId}&tournament=${tournamentId}`;
            fetch(url).then((response) => {
                return response.json();
            }).then((data) => {
                $("#message").text("");
                $("#players").html("");
                if (data.status == "success") {
                    if (data.players.length > 0) {
                        players = data.players.map((player, i) => {
                            $("#players").append(`<p><strong>Player ${i + 1}</strong>: ${player.gameName}</p>`);
                            return player.gameName;
                        });
                        phase = data.phase;
                        let button = $("#select");
                        button.on("click", setScoreboard);
                        button.attr("disabled", false);
                    } else {
                        $("#select").attr("disabled", true);
                        $("#message").text("No matches queued for stream, or the tournament is done.");
                    }

                } else {
                    $("#select").attr("disabled", true);
                    $("#message").text("None found!");
                }
            });
        }

        function set(target) {
            let value = $(target).text();
            $("#duplicates").empty();
            $("#player-name").val(value);
            $("#player-table").empty();
            getResults();
        }

        function setScoreboard() {
            players.forEach((element, i) => {
                $(`#player${i + 1}`).val(element);
            });
            $('#bracket').val(phase);
        }

        function showDoubles() {
            doubles = !doubles;
            $(".doubles").toggle();
        }

        function showBracket() {
            let fullUrl = `https://challonge.com/${$("#bracketLink").val()}/module`;
            $("#bracket-page").attr("src", fullUrl);
            $("#bracket-page").height("500px");
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            var src = document.getElementById(ev.dataTransfer.getData("text"));
            var tgt = ev.currentTarget;
            let temp = ev.target.value;
            ev.target.value = src.value;
            src.value = temp;
        }

        function getResults() {
            $("#player-message").empty();
            let playerName = $("#player-name").val();
            let game = $("#game").val();
            let url = `http://localhost:3000/smasher?name=${playerName}&game=${game}`;
            fetch(url).then((response) => {
                return response.json();
            }).then((data) => {
                if (data.type == "duplicate") {
                    let duplicatePlayers = data.data;
                    duplicatePlayers.forEach((player) => {
                        $("#duplicates").append(`<button class='btn btn-primary' onclick='set(this)'>${player}</button>`);
                    });
                } else if (data.type == "empty") {
                    $("#player-message").text(data.message);
                } else {
                    let placings = data.data;
                    let rows = placings.rows;
                    placings.rows = rows.slice(rows.length - 10);
                    createResults(placings);
                }
            });
        }

        function createLocalLink() {
            fetch(`http://localhost:3000/address`).then((response) => {
                return response.json();
            }).then((data) => {
                let link = `http://${data.address}:${data.port}`;
                let toCopy = $(`<input id="copy" value="${link}">`);
                $("#address-area").append(toCopy);
            });
        }

        function createResults(results) {
            let headers = results.headers;
            let rows = results.rows;
            lastRankings = results;
            let table = $("#player-table");
            table.empty();
            let head = $("<tr>");
            headers.forEach((item) => {
                head.append($(`<th>${item}</th>`));
            });
            let body = $("<tbody>");
            rows.forEach((row) => {
                let singleRow = $("<tr>");
                row.forEach((item) => {
                    singleRow.append($(`<td>${item}</td>`));
                });
                body.append(singleRow);
            });
            table.append(head);
            table.append(body);
        }

        function setChat() {
            let link = $("#stream-value").val();
            let fullLink = `https://www.twitch.tv/embed/${link}/chat`;
            let iframe = $('#chat-src');
            iframe.height("500px");
            iframe.attr("src", fullLink);
        }
    </script>
    <style>
        #scoreboard {
            margin: 2rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .hide {
            display: none;
        }
        #content {
            padding: 0.5rem;
        }
        body {
            height: 100vh;
        }
        label {
            margin-right: 1rem;
        }
        #area {
            width: 80%;
        }
        .doubles {
            display: none;
        }
        #center-frame {
            text-align: center;
            margin: 1rem;
        }
        h4 {
            margin-right: .5rem;
            margin-top: .5rem;
        }
        input[type="number"] {
            width: 5em;
        }
        .frame {
            display: none;
        }
        .input-row {
            display: flex;
            flex-direction: column;
        }
        #lower-button {
            text-align: center;
            padding: 0.5rem;
        }
        @media (min-width: 600px) {
            .input-row {
                flex-direction: row;
            }
            .left {
                margin-left: 1rem;
            }
        }
        input:hover[type="text"] {
            cursor: grab;
        }
    </style>
    <title>Scoreboard</title>
</head>

<body>
    <div id="scoreboard">
        <div id="area">
            <h1>Scoreboard</h1>
            <div id="address-area">
                <button class="btn btn-primary" onclick="createLocalLink()">View Address</button>
            </div>
            <form>
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab"
                            aria-controls="home" aria-selected="true">Game Info</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile"
                            aria-selected="false">Commentary Info</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="smashgg-tab" data-toggle="tab" href="#tournament" role="tab"
                            aria-controls="profile" aria-selected="false">Smash.gg</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="challonge-tab" data-toggle="tab" href="#bracketArea" role="tab"
                            aria-controls="profile" aria-selected="false">Challonge</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="results-tab" data-toggle="tab" href="#player-results" role="tab"
                            aria-controls="profile" aria-selected="false">Player Results</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="stream-tab" data-toggle="tab" href="#stream-chat" role="tab"
                            aria-controls="profile" aria-selected="false">Stream Chat</a>
                    </li>
                </ul>
                <div class="tab-content border border-top-0" id="content">
                    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                        <div>
                            <h4>Players</h4>
                            <div class="input-row">
                                <div class="form-group">
                                    <label for="exampleInputPassword1">Player 1</label>
                                    <input id="player1" draggable="true" type="text" ondragstart="drag(event)" ondrop="drop(event)"
                                        ondragover="allowDrop(event)" placeholder="Player 1 Tag" autocomplete="off">
                                </div>
                                <div class="form-group doubles">
                                    <label class="left" for="exampleInputPassword3">Player 3</label>
                                    <input id="player3" draggable="true" type="text" ondragstart="drag(event)" ondrop="drop(event)"
                                        ondragover="allowDrop(event)" placeholder="Player 3 Tag" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label class="left">Score 1</label>
                                    <input type="number" min="0" id="score1" value="0">
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="form-group">
                                    <label for="exampleInputPassword1">Player 2</label>
                                    <input id="player2" draggable="true" type="text" ondragstart="drag(event)" ondrop="drop(event)"
                                        ondragover="allowDrop(event)" placeholder="Player 2 Tag" autocomplete="off">
                                </div>
                                <div class="form-group doubles">
                                    <label for="exampleInputPassword4" class="left">Player 4</label>
                                    <input id="player4" draggable="true" type="text" ondragstart="drag(event)" ondrop="drop(event)"
                                        ondragover="allowDrop(event)" placeholder="Player 4 Tag" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label class="left">Score 2</label>
                                    <input type="number" min="0" id="score2" value="0" width="10">
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="doSwapNames('info')">Swap</button>
                            <label>
                                <label for="doubles">Doubles?</label>
                                <input type="checkbox" onchange="showDoubles()">
                            </label>
                            <h4>Game Info</h4>
                            <div class="input-row">
                                <div class="form-group">
                                    <label>Bracket</label>
                                    <input id="bracket" draggable="true" type="text" ondragstart="drag(event)" ondrop="drop(event)"
                                        ondragover="allowDrop(event)" placeholder="Location in Bracket" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label>Bracket Link</label>
                                    <input id="link" draggable="true" type="text" ondragstart="drag(event)" ondrop="drop(event)"
                                        ondragover="allowDrop(event)" placeholder="Link for Bracket" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input id="date" draggable="true" type="text" ondragstart="drag(event)" ondrop="drop(event)"
                                        ondragover="allowDrop(event)" placeholder="Date" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label>Location</label>
                                    <input id="location" draggable="true" type="text" ondragstart="drag(event)" ondrop="drop(event)"
                                        ondragover="allowDrop(event)" placeholder="location" autocomplete="off">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                        <div>
                            <h4>Commentators</h4>
                            <div class="input-row">
                                <div class="form-group">
                                    <label for="exampleInputPassword1">Commentator 1</label>
                                    <input id="commName1" placeholder="Commentator 1 Name">
                                </div>
                                <div class="form-group">
                                    <label class="left" for="exampleInputPassword1">Commentator 1 Twitter</label>
                                    <input id="commTwitter1" placeholder="Commentator 1 Twitter">
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="form-group">
                                    <label for="exampleInputPassword1">Commentator 2</label>
                                    <input id="commName2" placeholder="Commentator 2 Name">
                                </div>
                                <div class="form-group">
                                    <label class="left" for="exampleInputPassword1">Commentator 2 Twitter</label>
                                    <input id="commTwitter2" placeholder="Commentator 2 Twitter">
                                </div>
                            </div>
                            <div>
                                <button id="challonge" class="btn btn-secondary" style="margin-bottom: 1rem" onclick="doSwapNames('comms')">Swap</button>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tournament" role="tabpanel" aria-labelledby="profile-tab">
                        <div>
                            <h4>Smash.gg</h4>
                            <div>
                                <div>
                                    <label>Enter the tourney slug name (located after "tournament" in the Smash.gg
                                        link)</label>
                                </div>
                                <input id="tournamentName" placeholder="Tourney slug (with '-')">
                                <button class="btn btn-secondary" onclick="getTournamentInfo()">Search</button>
                            </div>
                            <div id="results" class="hide">
                                <h5>On stream:</h5>
                                <div id="tourney-name"></div>
                                <div id="events">
                                    <select id="event-options"></select>
                                    <button class="btn btn-secondary" onclick="eventSet()">Set Event</button>
                                </div>
                                <div id="message"></div>
                                <div id="players"></div>
                                <button class="btn btn-primary" disabled id="select">Set to Scoreboard</button>
                            </div>

                        </div>
                    </div>
                    <div class="tab-pane fade" id="bracketArea" role="tabpanel" aria-labelledby="profile-tab">
                        <div>
                            <h4>Challonge</h4>
                            <div>
                                <div>
                                    <label for="bracketLink">Paste in the link to the place in bracket (only the last
                                        part of the url!)</label>
                                </div>
                                <input id="bracketLink" placeholder="Paste in the link to the place in bracket">
                                <button class="btn btn-secondary" onclick="showBracket()">Search</button>
                            </div>
                            <iframe id="bracket-page" width="100%" height="20" frameborder="0" scrolling="auto"
                                allowtransparency="true"></iframe>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="player-results" role="tabpanel" aria-labelledby="results-tab">
                        <div>
                            <h4>Player Results</h4>
                            <div>
                                <div>
                                    <label for="player-name">Enter the player name (with correct spelling and
                                        capitalization) to see their past 10 results</label>
                                </div>
                                <input id="player-name" placeholder="Player name">
                                <select id="game">
                                    <option>Super Smash Bros. Ultimate</option>
                                    <option>Super Smash Bros. Melee</option>
                                    <option>Super Smash Bros. for Wii U</option>
                                    <option>Project M</option>
                                    <option>Super Smash Bros. Brawl</option>
                                </select>
                                <button class="btn btn-secondary" onclick="getResults($('#player-name').val())">Search</button>
                            </div>
                            <div id="duplicates"></div>
                            <div id="player-message"></div>
                            <div id="player-results">
                                <table id="player-table" class="table"></table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="stream-chat" role="tabpanel" aria-labelledby="stream-tab">
                        <h1>Stream Chat</h1>
                        <form>
                            <div>
                                <label>Stream</label>
                                <input id="stream-value">
                                <button class="btn btn-secondary" onclick="setChat()">Set</button>
                            </div>
                            <div id="center-frame">
                                <iframe id="chat-src" height="0" width="400"></iframe>
                            </div>
                        </form>
                    </div>
                    <div id="lower-button" class="border">
                        <button type="submit" class="btn btn-primary">Update!</button>
                    </div>
            </form>
        </div>

    </div>
</body>

</html>